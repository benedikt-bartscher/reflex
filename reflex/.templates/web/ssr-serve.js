/**
 * Bot-aware SSR production server for Reflex apps.
 *
 * - Crawlers/bots receive fully server-side rendered HTML (SEO).
 * - Regular users receive the static SPA shell (fast, zero SSR overhead).
 *
 * Used when `runtime_ssr=True` is set in the Reflex config.
 */
import { createRequestHandler } from "@react-router/express";
import express from "express";
import compression from "compression";
import { isbot } from "isbot";
import { existsSync } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";

// Resolve all paths relative to *this file*, not process.cwd().
const __dirname = import.meta.dirname ?? dirname(fileURLToPath(import.meta.url));

const clientDir = join(__dirname, "build", "client");
const serverEntry = join(__dirname, "build", "server", "index.js");

const buildModule = await import(serverEntry);

const app = express();
app.disable("x-powered-by");
app.use(compression());

// Static assets with content-hash filenames — cache immutably.
app.use(
  "/assets",
  express.static(join(clientDir, "assets"), { immutable: true, maxAge: "1y" })
);

// Other static files (favicon, sitemap, etc.) — short cache.
app.use(express.static(clientDir, { maxAge: "1h" }));

// SSR request handler (React Router).
const ssrHandler = createRequestHandler({ build: buildModule });

// Check if the static SPA shell exists (generated by generate-shell.mjs).
const shellPath = join(clientDir, "index.html");
const hasShell = existsSync(shellPath);
if (!hasShell) {
  console.warn(
    "[ssr-serve] build/client/index.html not found — all requests will use SSR."
  );
}

app.all("*", (req, res, next) => {
  const ua = req.headers["user-agent"] || "";

  // Bots always get full server-side rendered HTML with state data.
  // Also used as fallback when the static shell is unavailable.
  if (isbot(ua) || !hasShell) {
    return ssrHandler(req, res, next);
  }

  // For regular users: only serve the SPA shell for initial document requests
  // (browser navigating to a URL).  React Router's .data requests (used for
  // client-side navigations) and other non-document fetches must go through
  // the SSR handler so the root loader can run and return JSON state data.
  const accept = req.headers["accept"] || "";
  if (accept.includes("text/html") && !req.url.endsWith(".data")) {
    return res.sendFile(shellPath);
  }

  // .data requests, API calls, etc. → SSR handler (runs loaders, returns JSON).
  return ssrHandler(req, res, next);
});

const port = parseInt(process.env.PORT || "3000", 10);
app.listen(port, () => {
  // Message format matches Reflex's PROD_FRONTEND_LISTENING_REGEX.
  console.log(`[ssr-serve] http://localhost:${port}`);
});
